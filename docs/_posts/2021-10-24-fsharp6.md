---
layout: post
title: "F# 6.0 の新機能"
date: 2021-10-24 12:00:00 +0900
image: "https://raw.githubusercontent.com/tatsuya-midorikawa/images/main/fsdoc-jp/common/fs-octcat.png"
description: F# 6.0 の新機能について紹介します。
categories: [posts]
tags: ["新機能"]
---

## F# 6.0 の新機能  
[What's new in F# 6](https://devblogs.microsoft.com/dotnet/whats-new-in-fsharp-6/) の情報になります。  
[F# 6.0](https://docs.microsoft.com/ja-jp/dotnet/fsharp/whats-new/fsharp-60) が追加され次第、こちらの更新していきます。  

<br>

### task コンピュテーション式  
C# などの他の .NET 言語との相互運用性を高めるために Task<'T> 専用のコンピュテーション式が追加されました。  
F# 5.0 までは ```async {...}``` 内で ```Async.AwaitTask``` で Task<'T> を Async<'T> に変換しつつ利用する必要がありました。  
F# 6.0 からは ```task {...}``` で直接扱えるようになりました。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=task-5.0.fs"></script>  
<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=task-6.0.fs"></script>  

<br>  

### インデックス構文のシンプル化  
F# でインデックスを利用したアクセスをする場合には ```expr.[idx]``` が構文として提供されてきました。  
F# 6.0 では C# のように ```.``` を使わない ```expr[idx]``` が新たにサポートされるようになりました。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=indexer-5.0.fs"></script>  
<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=indexer-6.0.fs"></script>  

<br>

### アクティブ パターンの構造体サポート  
アクティブ パターンの戻り値は構造体でも問題ないような場合でも、参照型でしか表現できなかったためシナリオによってはコストが割高でした。  
F# 6.0 では構造体として表現できるようになりました。  
利用方法は簡単で、今までのアクティブパターンに ```[<return: Struct>]``` 属性を追加するだけです。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=active-pattern-6.0.fs"></script>  

<br>  

### コンピュテーション式のカスタム オペレーションのオーバーロード サポート  
F# 5.0 で preview 提供されていたコンピュテーション式のカスタム オペレーションのオーバーロード サポートが正式導入されました。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=custome-operation-overload-6.0.fs"></script>  

<br>  

### as パターンの機能拡張  
F# 5.0 までは as パターンの右辺でパターンマッチを使用できませんでした。  
F# 6.0 からは as パターンの右辺でパターンマッチを利用できるようになりました。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=as-pattern-5.0.fs"></script>  
<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=as-pattern-6.0.fs"></script>  

<br>  

### インデントルールの統一  
F# 5.0 までは使用する機能によってインデントルールが異なることで F# の学習コストが上がってしまっていました。  
F# 6.0 からはその差異を埋めることで、より統一的なインデントルールを提供しています。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=indent-5.0.fs"></script>  
<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=indent-6.0.fs"></script>  

<br>  

### use バインディングの破棄  
F# 6.0 では use バインディングでも ```_``` で束縛できるようになりました。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=use-bindings-6.0.fs"></script>  

<br>  

### 2 進数表現用のフォーマット指定子の追加  
F# 6.0 では、数値を 2 進数表現するためのフォーマット指定子が追加されました。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=formatting-for-binary-numbers-6.0.fs"></script>  

<br>  

### InlineIfLambda 属性の追加  
F# 6.0 では、ラムダ式 を引数で指定する場合に inline 化されるべきであることを宣言するための属性が追加されました。
<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=inline-if-lambda-6.0.fs"></script>  

呼び出し方は特に今までと変わりません。  
<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=inline-if-lambda-callsite-6.0.fs"></script>  

上記の例は以下のように展開されます。  
<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=inline-if-lambda-after-inlining-6.0.fs"></script>  

この inline 化はラムダ式のサイズに関係なく適用されます。

<br>

### リストと配列の生成式のパフォーマンスとデバッグの改善  
F# 6.0 では、リストと配列の生成式が最大 4 倍高速になりました。  
また、個々の行にブレークポイントを設定できるようになりました。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=improved-performance-and-debugging-for-list-and-array-expressions-6.0.fs"></script>  

<br>

### 暗黙的な型変換の緩和  

F# 6.0 では、[RFC FS-1093](https://github.com/fsharp/fslang-design/blob/main/FSharp-6.0/FS-1093-additional-conversions.md) で記載されているような暗黙的な型変換が追加サポートされました。  
この変更により、以下の 3 つのことが実現されます。  

- 明示的なアップキャストが減る
- int32 型の明示的な型変換が減る
- .NET スタイルの暗黙的な型変換のサポート

1. **明示的なアップキャストが減る**  
F# 5.0 以前では、関数の宣言で型アノテーションが指定されていても、分岐で異なるサブタイプの戻り値を返す関数を実装する場合には戻り値にアップキャストが必要でした。  
F# 6.0 からは、自動でアップキャストされるようになりました。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=additional-implicit-upcast-conversions-5.0.fs"></script>  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=additional-implicit-upcast-conversions-6.0.fs"></script>  

<br>

2. **int32 の明示的な型変換が減る**  
F# 6.0 では、 int32 → int64 や int32 → double など、変換元の型と変換先の型が両方わかっていれば暗黙的な型変換が行われるようになりました。  
ただし、変換先の型の表現できる範囲が int32 よりも広い必要があります。また、 int8 や int16、float などの int32 以外の型の場合や、変換元や変換先の型が不明な場合には暗黙的な型変換は自動で行われません。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=implict-integer-conversions-5.0.fs"></script>  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=implict-integer-conversions-6.0.fs"></script>  

<br>

3. **.NET スタイルの暗黙的な型変換のサポート**  
F# 5.0 までは .NET の暗黙的な型変換実装(op_Implicit)を利用して、明示的な型変換をする必要がありました。  
F# 6.0 からは自動で op_Implicit を呼び出すようになります。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=dotnet-style-implicit-conversions-5.0.fs"></script>  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=dotnet-style-implicit-conversions-6.0.fs"></script>  

<br>

### immutable コレクション用モジュールのアップデート  

FSharp.Core 6.0.0.0 からコレクション用モジュール (List / Array / Seq モジュール) に以下の 5 つの関数が追加されました。  

- [List / Array / Seq.insertAt](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-collections-listmodule.html#insertAt)
- [List / Array / Seq.removeAt](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-collections-listmodule.html#removeAt)
- [List / Array / Seq.updateAt](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-collections-listmodule.html#updateAt)
- [List / Array / Seq.insetManyAt](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-collections-listmodule.html#insertManyAt)
- [List / Array / Seq.removeManyAt](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-collections-listmodule.html#removeManyAt)

これらの操作は、対象のコレクションに対してコピーと更新を行うため、元のコレクションに変更が加わりません。そのため、immutable なデータのみに依存することになり、ロジックが明確かつシンプルになります。  
各関数の使用方法についてはリンク先のドキュメントを参照してください。  

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=updating-immutable-collections-6.0.fs"></script>  

<br>

### Map<'Key, 'Value> への Keys / Values プロパティの追加  
FSharp.Core 6.0.0.0 から Map<'Key, 'Value> へ Keys と Values が追加されました。  
これらのプロパティは元のコレクションをコピーして返すものではないので注意が必要です。  

- [Map<'Key, 'Value>.Keys](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-collections-fsharpmap-2.html#Keys)
- [Map<'Key, 'Value>.Values](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-collections-fsharpmap-2.html#Values)

<script src="https://gist.github.com/fffsharp/25a4f75924ae688b6b7d1ed4d8fdaa1a.js?file=map-has-keys-and-values-6.0.fs"></script>  

<br>

### NativePtr モジュールのアップデート  
FSharp.Core 6.0.0.0 から NativePtr モジュールに以下の 8 つの関数が追加されました。  

- [NativePtr.nullPtr](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-nativeinterop-nativeptrmodule.html#nullPtr)
- [NativePtr.isNullPtr](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-nativeinterop-nativeptrmodule.html#isNullPtr)
- [NativePtr.initBlock](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-nativeinterop-nativeptrmodule.html#initBlock)
- [NativePtr.clear](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-nativeinterop-nativeptrmodule.html#clear)
- [NativePtr.copy](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-nativeinterop-nativeptrmodule.html#copy)
- [NativePtr.copyBlock](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-nativeinterop-nativeptrmodule.html#copyBlock)
- [NativePtr.ofILSigPtr](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-nativeinterop-nativeptrmodule.html#ofILSigPtr)
- [NativePtr.toILSigPtr](https://fsharp.github.io/fsharp-core-docs/reference/fsharp-nativeinterop-nativeptrmodule.html#toILSigPtr)

上記の関数は NativePtr モジュールの他の関数と同様、インライン化されています。  
また、/nowarn:9 が使われていない限り警告が発生します。  
これらの関数はアンマネージド型にしか利用できません。  

<br>

### 測定単位が使える型を拡大





### (Coming soon...)
